# Milestone v1.2: Production Polish

**Status:** ✅ SHIPPED 2026-02-09
**Phases:** v1.2-01 to v1.2-06
**Total Plans:** 13

## Overview

v1.2 adds production-essential features: WinterCG Streams API for streaming responses, per-app environment variables for configuration, graceful shutdown with connection draining, API spec compliance, and documentation. The phase order prioritized low-risk foundation (env vars) before complex streaming, shutdown logic, and spec fixes.

## Phases

### Phase v1.2-01: Per-App Environment Variables

**Goal:** Apps can access isolated environment variables from config
**Depends on:** Phase v1.1-02 (config system exists)
**Plans:** 1 plan

Plans:
- [x] v1.2-01-01-PLAN.md — Extend config parsing, pass env to fetch handler, verify isolation

**Success Criteria:**
1. App can read environment variables via second fetch handler parameter
2. Environment variables are defined in config.json per app
3. App A cannot access App B's environment variables
4. Environment variables update when config is hot-reloaded

### Phase v1.2-02: Streams Foundation

**Goal:** WinterCG-compliant ReadableStream and WritableStream classes work independently
**Depends on:** Nothing (independent feature)
**Plans:** 3 plans in 2 waves

Plans:
- [x] v1.2-02-01-PLAN.md — ReadableStream foundation (Wave 1)
- [x] v1.2-02-02-PLAN.md — WritableStream foundation (Wave 1, parallel with 01)
- [x] v1.2-02-03-PLAN.md — TransformStream, pipe ops, utilities, text streams (Wave 2)

### Phase v1.2-03: Response Body Integration

**Goal:** HTTP responses support streaming bodies via ReadableStream
**Depends on:** Phase v1.2-02 (streams exist)
**Plans:** 1 plan

Plans:
- [x] v1.2-03-01-PLAN.md — Extend Response with .body getter, ReadableStream constructor support, streaming text()/json()

### Phase v1.2-04: Graceful Shutdown & Stability

**Goal:** Process and apps shutdown cleanly with connection draining; server remains stable under timer-driven workloads
**Depends on:** Nothing (independent feature, touches HTTP layer)
**Plans:** 2 plans (executed inline during GA quality fixes)

Plans:
- [x] v1.2-04-01 — AppDrainState, per-app connection tracking, 503 drain routing, removeApp drain-wait
- [x] v1.2-04-02 — processEventLoop V8 lifecycle fix, TryCatch for timer callbacks, xev timer rearm fix, DOMException→Error

**Delivered (2026-02-08):**
- AppDrainState struct with per-app active_connections tracking
- 503 Service Unavailable for draining apps
- removeApp() with 30s drain timeout
- initiateGracefulShutdown() marks all apps as draining
- SIGTERM/SIGINT signal handlers in both serve modes
- processEventLoop enters isolate+HandleScope+Context before V8 calls
- TryCatch wrapper around timer callback execution
- xev timer reschedule fix (manual timer.run instead of .rearm to prevent spin loop)
- AbortSignal.timeout uses Error instead of undefined DOMException
- Code cleanup: js.throw() and js.retResolvedPromise/retRejectedPromise helpers

### Phase v1.2-05: API Spec Compliance

**Goal:** Fix systematic WinterCG spec violations so standard Workers code runs unmodified
**Depends on:** Phase v1.2-03 (all APIs exist)
**Plans:** 3 plans in 3 waves

Plans:
- [x] v1.2-05-01 — Properties→getters migration (Blob, Request, Response, URL, AbortController)
- [x] v1.2-05-02 — Headers fixes (delete, append) + Blob binary parts + crypto digest BufferSource
- [x] v1.2-05-03 — Console object inspection + test verification

**Known limitations (deferred):**
- Buffer size limits (Blob 64KB, fetch body 64KB, atob 8KB)
- fetch() synchronous I/O
- WritableStream async sinks
- crypto.subtle RSA/ECDSA/encrypt/decrypt
- ReadableStream.tee() data sharing
- EventTarget/Event system
- DOMException class

### Phase v1.2-06: Documentation Site

**Goal:** Public documentation site explains NANO setup, APIs, and deployment
**Depends on:** Phase v1.2-05 (API behavior is finalized before documenting)
**Plans:** 2 plans

Plans:
- [x] v1.2-06-01-PLAN.md — Astro + Starlight scaffold, Getting Started, Config reference
- [x] v1.2-06-02-PLAN.md — API reference, WinterCG compliance, Deployment guides

## Progress

| Phase                        | Plans | Status     | Completed  |
| ---------------------------- | ----- | ---------- | ---------- |
| v1.2-01. Per-App Env Vars    | 1/1   | ✓ Complete | 2026-02-02 |
| v1.2-02. Streams Foundation  | 3/3   | ✓ Complete | 2026-02-07 |
| v1.2-03. Response Body       | 1/1   | ✓ Complete | 2026-02-07 |
| v1.2-04. Graceful Shutdown   | 2/2   | ✓ Complete | 2026-02-08 |
| v1.2-05. API Spec Compliance | 3/3   | ✓ Complete | 2026-02-08 |
| v1.2-06. Documentation       | 2/2   | ✓ Complete | 2026-02-09 |

## Milestone Summary

**Key Decisions:**
- Embedded JS for complex async stream operations (TransformStream, pipeTo, tee)
- setAccessorGetter with .toName() as standard pattern for WinterCG spec properties
- xev timer manual .run() instead of .rearm to prevent infinite spin loop
- Astro + Starlight for documentation (built-in search, MDX support)

**Issues Resolved:**
- Properties as methods → converted to getter accessors (24 properties)
- Headers.delete() → undefined → now properly removes keys
- console.log [object Object] → uses JSON.stringify
- Response.statusText hardcoded "OK" → maps via std.http.Status.phrase()
- V8 timer callback crashes → TryCatch + proper isolate lifecycle

**Issues Deferred:**
- 8 items tracked in BACKLOG.md (B-01 through B-08)
- Buffer limits, sync fetch, limited crypto, missing WinterCG APIs

**Technical Debt Incurred:**
- Phase v1.2-04 executed inline without standard SUMMARY.md files
- Request properties still accessed as methods (not getters) due to V8 binding complexity

---

_For current project status, see .planning/ROADMAP.md_
