---
phase: 02-api-surface
plan: 04
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/repl.zig
  - src/main.zig
autonomous: true

must_haves:
  truths:
    - "nano repl starts interactive session"
    - "Variables persist across inputs"
    - "Errors don't crash the REPL"
    - "Ctrl+C or 'exit' quits cleanly"
  artifacts:
    - path: "src/repl.zig"
      provides: "REPL implementation"
      exports: ["runRepl"]
---

<objective>
Implement interactive REPL (Read-Eval-Print-Loop) for JavaScript development.

Purpose: Essential developer experience - test code interactively, explore APIs,
debug issues without creating files.

Output: `nano repl` command that starts persistent JS session.
</objective>

<context>
Unlike `eval`, REPL needs:
- Single persistent V8 isolate and context (variables persist)
- Line-by-line input from stdin
- Continue prompt for incomplete expressions
- Error recovery (don't exit on error)
- Clean shutdown on exit/Ctrl+C

Pattern:
```
nano> let x = 1
undefined
nano> x + 1
2
nano> function add(a,b) { return a+b }
undefined
nano> add(x, 10)
11
nano> exit
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create REPL module</name>
  <files>src/repl.zig</files>
  <action>
Create REPL implementation:

1. Initialize V8 once, create persistent isolate/context
2. Read line from stdin
3. Check for exit commands ("exit", ".exit", Ctrl+D)
4. Compile and run in persistent context
5. Print result (or "undefined" for statements)
6. On error, print message and continue (don't exit)
7. Loop back to step 2

Handle multi-line input:
- If compile fails with "Unexpected end of input", show continuation prompt
- Accumulate lines until expression is complete
  </action>
  <verify>
Build succeeds.
  </verify>
</task>

<task type="auto">
  <name>Task 2: Add repl command to CLI</name>
  <files>src/main.zig</files>
  <action>
Add "repl" command to CLI that calls runRepl().
Update help text to include repl command.
  </action>
  <verify>
`nano repl` starts interactive session.
Variables persist: `let x = 1` then `x` returns 1.
Errors don't crash: `throw 1` shows error, continues.
`exit` quits cleanly.
  </verify>
</task>

</tasks>

<success_criteria>
- `nano repl` starts interactive prompt "nano> "
- Variables persist across lines
- Syntax errors show message and continue
- Runtime errors show message and continue
- Multi-line functions work (continuation prompt)
- `exit` or Ctrl+D quits cleanly
- console.log works in REPL
</success_criteria>
