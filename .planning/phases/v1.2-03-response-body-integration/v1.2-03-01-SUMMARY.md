# Summary: v1.2-03-01 Response.body Streaming Integration

## What Was Built

Extended the Response class with ReadableStream body support, enabling streaming HTTP response bodies per WinterCG spec.

### Changes

1. **`src/api/fetch.zig`** — Response.body getter + ReadableStream constructor support
   - Changed `Response.body` from method to accessor getter (`setAccessorGetter`) matching WinterCG property semantics
   - `responseConstructor`: Detects ReadableStream bodies via `locked` property check, stores as `_bodyStream`
   - `responseBody`: Returns cached `_bodyStream` or lazily creates ReadableStream from string body using pull()-based JS
   - `responseText`: Stream-aware — reads all chunks via getReader() when `_bodyStream` exists, falls back to `_body` string
   - `responseJson`: Reuses text() for stream reading, then parses JSON

2. **`src/api/readable_stream.zig`** — Fixed pull-based stream reading
   - `readerRead`: After calling pull() callback, re-checks queue for synchronously enqueued data
   - Guards against V8 pending exceptions by checking pull_fn.call() result before further V8 operations
   - Re-checks stream state after pull() (handles case where pull closes the stream)

3. **`test/apps/response-body-test/index.js`** — Comprehensive test app with 6 endpoints
4. **`test/response-body.json`** — Test configuration

### Test Results

| Endpoint | Result | Expected |
|----------|--------|----------|
| `/test-string-body` | `{"bodyType":"ReadableStream","locked":false,"hasGetReader":true}` | Response.body returns ReadableStream for string bodies |
| `/test-stream-body` | `{"bodyType":"ReadableStream","locked":false,"isSameReference":true}` | ReadableStream constructor arg preserved |
| `/test-null-body` | `{"bodyIsNull":true}` | Null body returns null |
| `/test-fetch-streaming` | `{"chunksReceived":10,"totalBytes":102400}` | 10x10KB chunks streamed correctly |
| `/test-text-from-stream` | `{"text":"hello world","expected":"hello world","match":true}` | response.text() reads from stream |
| `/test-json-from-stream` | `{"parsed":{"key":"value"},"keyValue":"value"}` | response.json() reads from stream |

All 6 tests pass, including repeated requests to the same endpoints.

### Key Technical Decisions

- **pull() instead of start()**: ReadableStream bodies use pull()-based callbacks to avoid synchronous close() blocking issues
- **Accessor getter**: `Response.body` uses `setAccessorGetter` (like `ReadableStream.locked`) rather than `set` (method), so `response.body` returns the value directly instead of requiring `response.body()` call
- **V8 exception guard**: After calling pull(), check if `pull_fn.call()` returned null (indicating a thrown exception) before doing further V8 API calls, preventing state corruption

### Commits

- `116572b` feat(v1.2-03-01): add Response.body getter and ReadableStream support
- `d549759` fix(v1.2-03-01): use pull() instead of start() for Response.body ReadableStream
- `4038cb2` test(v1.2-03-01): create Response.body test application
- `96893cc` fix(v1.2-03-01): fix Response.body getter and ReadableStream pull-based reading

## Deviations

1. **ReadableStream from string uses pull() not start()**: Plan specified `start(controller)` callback pattern, but `start()` with synchronous `controller.close()` causes server hangs (pre-existing bug). Using `pull()` is functionally equivalent and avoids the issue.
2. **Additional readable_stream.zig fix required**: Plan didn't account for readerRead needing modification — the existing implementation rejected promises immediately after calling pull() instead of re-checking the queue.
3. **Test app URL routing**: NANO's `url.pathname` is a method (`url.pathname()`) not a property — required fixing in the test app.

## Goal Verification

- [x] Response.body returns ReadableStream for string bodies (test-string-body)
- [x] Response.body returns ReadableStream for ReadableStream bodies (test-stream-body)
- [x] Response.body returns null for empty bodies (test-null-body)
- [x] Streaming consumption via .body.getReader() works (test-fetch-streaming)
- [x] Large responses stream without buffering entire content (10x10KB = 100KB streamed)
- [x] Response.text() reads from stream body (test-text-from-stream)
- [x] Response.json() reads from stream body (test-json-from-stream)
