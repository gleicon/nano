# Plan 04-01: Snapshot Creation Tool

## Goal
Create a build-time tool that generates a V8 snapshot with all Workers-compatible APIs pre-registered.

## Prerequisites
- Phase 3 complete (all APIs implemented)
- Understanding of V8 snapshot creation

## Implementation Steps

### Step 1: Create snapshot generator module
Create `src/snapshot/create.zig`:
- Initialize V8 platform
- Create SnapshotCreator
- Get isolate from snapshot creator
- Create context with all APIs registered
- Set default context
- Generate snapshot blob

### Step 2: Build configuration
Update `build.zig`:
- Add snapshot generator as separate executable
- Add build step to generate snapshot
- Embed snapshot in main binary (optional)

### Step 3: Snapshot blob handling
Create `src/snapshot/blob.zig`:
- Load snapshot from file or embedded
- Validate snapshot data
- Provide to isolate creation

## Files to Create/Modify

| File | Action |
|------|--------|
| src/snapshot/create.zig | CREATE - Snapshot generator |
| src/snapshot/blob.zig | CREATE - Blob loading utilities |
| build.zig | MODIFY - Add snapshot build steps |

## Verification

```bash
# Build snapshot generator
zig build snapshot

# Generate snapshot
./zig-out/bin/nano-snapshot > nano.snapshot

# Verify snapshot file exists and has content
ls -la nano.snapshot
```

## Technical Notes

### Callback Serialization Issue
V8 cannot serialize C++ function pointers in snapshots. When registering APIs:
- FunctionTemplates are serialized
- But the actual callback addresses are not

**Solution**: After loading from snapshot, we need to re-register the callback handlers. This means:
1. Snapshot creates the object/function structure
2. Runtime hooks up the actual Zig callbacks

This is a known V8 snapshot limitation and requires careful design.

### Alternative Approach
For v1.0, we might defer full snapshot support and focus on:
1. Isolate pooling (reuse warm isolates)
2. Context caching (reuse contexts within an isolate)

This gives significant speedup without the callback serialization complexity.

## Estimated Complexity
HIGH - Snapshot callback restoration is complex

## Fallback
If snapshot callbacks prove too complex, implement isolate pooling first (04-03).
