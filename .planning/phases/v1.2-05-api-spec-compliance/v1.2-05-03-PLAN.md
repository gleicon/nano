---
phase: v1.2-05
plan: 03
type: execute
wave: 3
depends_on:
  - v1.2-05-01
  - v1.2-05-02
files_modified:
  - src/api/console.zig
  - test/apps/spec-compliance-test/index.js
  - test/apps/spec-compliance-test/config.json
autonomous: false

must_haves:
  truths:
    - "console.log({x: 1}) prints {\"x\":1} to stdout (not [object Object])"
    - "A test app exercises all fixed properties and methods end-to-end"
    - "All SPEC requirements verified: properties as getters, delete/append, binary Blob, binary digest, console inspection"
  artifacts:
    - path: "src/api/console.zig"
      provides: "JSON.stringify for object values in writeValue"
      contains: "JSON"
    - path: "test/apps/spec-compliance-test/index.js"
      provides: "End-to-end test for all SPEC-01 through SPEC-05 requirements"
      contains: "blob.size"
  key_links:
    - from: "console.zig writeValue"
      to: "JSON.stringify via V8 global"
      via: "context.getGlobal() -> getProp JSON -> getProp stringify -> fn.call"
      pattern: "JSON.stringify"
    - from: "test/apps/spec-compliance-test/index.js"
      to: "NANO server"
      via: "fetch handler returning test results"
      pattern: "export default"
---

<objective>
Fix console.log object inspection to use JSON.stringify, create a test app that exercises all spec compliance fixes, and verify all requirements pass end-to-end.

Purpose: Without this plan the fixes in plans 01-02 are unverified against actual runtime behavior.
Output: console.zig uses JSON.stringify for objects. Test app confirms all fixes work.
</objective>

<execution_context>
@/Users/gleicon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gleicon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/v1.2-05-api-spec-compliance/v1.2-05-01-SUMMARY.md
@.planning/phases/v1.2-05-api-spec-compliance/v1.2-05-02-SUMMARY.md

# JSON.parse pattern already proven in:
@src/api/request.zig
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix console.log to use JSON.stringify for object values</name>
  <files>src/api/console.zig</files>
  <action>
In `writeValue`, replace the fallback `else` branch (lines ~66-73) that calls `value.toString(context)` with JSON.stringify for object values:

```zig
} else if (value.isObject()) {
    // Use JSON.stringify for proper object inspection
    const global = context.getGlobal();
    const json_val = js.getProp(global, context, isolate, "JSON") catch {
        file.writeAll("[object]") catch {};
        return;
    };
    const json_obj = js.asObject(json_val);
    const stringify_fn_val = js.getProp(json_obj, context, isolate, "stringify") catch {
        file.writeAll("[object]") catch {};
        return;
    };
    const stringify_fn = js.asFunction(stringify_fn_val);
    var args: [1]v8.Value = .{value};
    const result = stringify_fn.call(context, json_val, &args) orelse {
        // Fall back if stringify fails (circular references, etc.)
        const str = value.toString(context) catch {
            file.writeAll("[object]") catch {};
            return;
        };
        var buf: [4096]u8 = undefined;
        file.writeAll(js.readString(isolate, str, &buf)) catch {};
        return;
    };
    const result_str = result.toString(context) catch {
        file.writeAll("[object]") catch {};
        return;
    };
    var buf: [4096]u8 = undefined;
    file.writeAll(js.readString(isolate, result_str, &buf)) catch {};
} else {
    const str = value.toString(context) catch {
        file.writeAll("[object]") catch {};
        return;
    };
    var buf: [4096]u8 = undefined;
    file.writeAll(js.readString(isolate, str, &buf)) catch {};
}
```

NOTE: The existing else branch handles non-object, non-primitive types (functions, symbols). Preserve it for those. The structure is: isString -> isNumber -> isBoolean -> isUndefined -> isNull -> isObject -> else.
  </action>
  <verify>Build succeeds: `rm -rf /Users/gleicon/code/zig/nano/.zig-cache && zig build -p /Users/gleicon/code/zig/nano/zig-out 2>&1` from /Users/gleicon/code/zig/nano</verify>
  <done>Build passes. console.zig contains "JSON" and "stringify" in writeValue function.</done>
</task>

<task type="auto">
  <name>Task 2: Create spec compliance test app and run end-to-end verification</name>
  <files>test/apps/spec-compliance-test/index.js, test/apps/spec-compliance-test/config.json</files>
  <action>
Create test/apps/spec-compliance-test/index.js:
```javascript
export default {
  async fetch(request) {
    const results = [];

    // SPEC-01: Properties as getters (no parentheses needed)
    const blob = new Blob(["hello"], { type: "text/plain" });
    results.push(`blob.size=${blob.size}`);
    results.push(`blob.type=${blob.type}`);

    const req = new Request("https://example.com/path?q=1");
    results.push(`req.url=${req.url}`);
    results.push(`req.method=${req.method}`);

    const resp = new Response("body", { status: 201 });
    results.push(`resp.status=${resp.status}`);
    results.push(`resp.ok=${resp.ok}`);
    results.push(`resp.statusText=${resp.statusText}`);

    const url = new URL("https://example.com:8080/path?q=1#hash");
    results.push(`url.hostname=${url.hostname}`);
    results.push(`url.pathname=${url.pathname}`);
    results.push(`url.port=${url.port}`);
    results.push(`url.search=${url.search}`);
    results.push(`url.hash=${url.hash}`);

    const ac = new AbortController();
    results.push(`ac.signal.aborted=${ac.signal.aborted}`);

    // SPEC-02: Headers.delete and append
    const h = new Headers({ foo: "bar" });
    h.delete("foo");
    results.push(`headers.has(foo)=${h.has("foo")}`);

    const h2 = new Headers();
    h2.append("x-test", "a");
    h2.append("x-test", "b");
    results.push(`headers.get(x-test)=${h2.get("x-test")}`);

    // SPEC-03: Blob with binary parts
    const binBlob = new Blob([new Uint8Array([72, 101, 108, 108, 111])]);
    results.push(`binBlob.size=${binBlob.size}`);

    // SPEC-04: crypto.subtle.digest with binary
    try {
      const hash = await crypto.subtle.digest("SHA-256", new Uint8Array([1, 2, 3]));
      results.push(`digest.byteLength=${hash.byteLength}`);
    } catch (e) {
      results.push(`digest.error=${e.message}`);
    }

    // SPEC-05: console.log object inspection (check output in server logs)
    console.log({ spec: "compliance", test: true });

    return new Response(results.join("\n"), {
      headers: { "Content-Type": "text/plain" }
    });
  }
};
```

Create test/apps/spec-compliance-test/config.json:
```json
{
  "apps": [
    {
      "name": "spec-compliance-test",
      "script": "test/apps/spec-compliance-test/index.js",
      "route": "localhost"
    }
  ]
}
```

Then build, start server, and run test:
```bash
# Build
rm -rf /Users/gleicon/code/zig/nano/.zig-cache && zig build -p /Users/gleicon/code/zig/nano/zig-out 2>&1

# Start server (background)
./zig-out/bin/nano serve --config test/apps/spec-compliance-test/config.json &
SERVER_PID=$!
sleep 2

# Run test
curl -s -H "Host: localhost" http://127.0.0.1:3000/

# Stop server
kill $SERVER_PID 2>/dev/null
```

Analyze output to confirm each result. Expected values:
- blob.size=5, blob.type=text/plain
- req.url=https://example.com/path?q=1, req.method=GET
- resp.status=201, resp.ok=false, resp.statusText=Created
- url.hostname=example.com, url.pathname=/path, url.port=8080, url.search=?q=1, url.hash=#hash
- ac.signal.aborted=false
- headers.has(foo)=false
- headers.get(x-test)=a, b
- binBlob.size=5
- digest.byteLength=32
- Server logs show: {"spec":"compliance","test":true}
  </action>
  <verify>
```bash
curl -s -H "Host: localhost" http://127.0.0.1:3000/
```
Output contains "blob.size=5", "headers.has(foo)=false", "headers.get(x-test)=a, b", "binBlob.size=5", "digest.byteLength=32"
  </verify>
  <done>All SPEC-01 through SPEC-05 requirements verified by test output. Each expected value matches. Server logs show JSON-formatted object from console.log.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify all spec compliance fixes end-to-end</name>
  <what-built>All spec compliance fixes: property getters, Headers.delete/append, Blob binary, crypto binary, console JSON</what-built>
  <action>
Manually verify the running server by running the curl test and checking output values match expected results as listed in Task 2. Check server logs for JSON object output from console.log.
  </action>
  <how-to-verify>
1. Start the server: `./zig-out/bin/nano serve --config test/apps/spec-compliance-test/config.json`
2. Test: `curl -H "Host: localhost" http://127.0.0.1:3000/`
3. Verify output contains:
   - blob.size=5 (not calling blob.size() with parentheses)
   - headers.has(foo)=false (delete actually removed it)
   - headers.get(x-test)=a, b (append worked)
   - binBlob.size=5 (binary Blob constructor)
   - digest.byteLength=32 (binary crypto digest)
4. Check server stdout/stderr for: {"spec":"compliance","test":true}
  </how-to-verify>
  <verify>curl -H "Host: localhost" http://127.0.0.1:3000/ returns expected values</verify>
  <done>User confirms all expected values present in curl output and JSON object visible in server logs</done>
  <resume-signal>Type "approved" if all checks pass, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
1. `grep "stringify" src/api/console.zig` returns lines showing JSON.stringify usage
2. Test app index.js exists at test/apps/spec-compliance-test/index.js
3. curl output from test server matches all expected values
4. Server logs show JSON object from console.log
</verification>

<success_criteria>
All SPEC requirements verified end-to-end:
- SPEC-01: Properties accessible without () on all API classes
- SPEC-02: Headers.delete removes key; Headers.append supports multi-value
- SPEC-03: Blob constructor accepts ArrayBuffer/Uint8Array parts
- SPEC-04: crypto.subtle.digest accepts ArrayBuffer/Uint8Array
- SPEC-05: console.log uses JSON.stringify for objects
- Build passes, test server runs, curl output confirms all fixes
</success_criteria>

<output>
After completion, create `.planning/phases/v1.2-05-api-spec-compliance/v1.2-05-03-SUMMARY.md`
</output>
